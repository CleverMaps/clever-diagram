!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("ELK")):"function"==typeof define&&define.amd?define(["d3","ELK"],t):e.CleverDiagram=t(e.d3,e.ELK)}(this,function(e,t){"use strict";var n=function(e,t){if("undefined"==typeof document)return t;e=e||"";var n=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");return i.type="text/css",n.appendChild(i),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e)),t}("._diagram_j6xbj_1 {\r\n\r\n}\r\n\r\n._diagram-nodes_j6xbj_9 {\r\n\r\n}\r\n\r\n._diagram-node_j6xbj_9 {\r\n    cursor: pointer;\r\n}\r\n\r\n._node-icon_j6xbj_25 {\r\n    text-anchor: middle;\r\n    user-select: none;\r\n}\r\n\r\n._diagram-edges_j6xbj_35 {\r\n    pointer-events: none;\r\n}\r\n\r\n._node-skeleton_j6xbj_43 {\r\n\r\n}\r\n\r\n._node-name_j6xbj_51 {\r\n    font-family: Roboto, sans-serif;\r\n    font-weight: 600;\r\n    user-select: none;\r\n}\r\n",{diagram:"_diagram_j6xbj_1","diagram-nodes":"_diagram-nodes_j6xbj_9","diagram-node":"_diagram-node_j6xbj_9","node-icon":"_node-icon_j6xbj_25","diagram-edges":"_diagram-edges_j6xbj_35","node-skeleton":"_node-skeleton_j6xbj_43","node-name":"_node-name_j6xbj_51"}),i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},s=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];i(this,e),this._handlers=t.reduce(function(e,t){return e[t]=[],e},{})}return r(e,[{key:"on",value:function(e,t){if(!(e in this._handlers))throw"No such event: "+e;return this._handlers[e].push(t),this}},{key:"off",value:function(e,t){if(!(e in this._handlers))throw"No such event: "+e;if(t){var n=this._handlers[e],i=n.indexOf(t);-1!=i&&n.splice(i,1)}else this._handlers[e]=[];return this}},{key:"add",value:function(e){return e in this._handlers||(this._handlers[e]=[]),this}},{key:"fire",value:function(e){if(!(e in this._handlers))throw"No such event: "+e;for(var t=this._handlers[e],n=arguments.length,i=Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0;o<t.length;o++)t[o].apply(this,i);return this}},{key:"destroy",value:function(){return this._handlers=null,this}}]),e}(),d=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"component";i(this,t),this._container=null,this._className=e,this._observable=new s(["enter","leave","click"]),this._lastData=null,this._svg=null}return r(t,[{key:"on",value:function(e,t){return this._observable.on(e,t),this}},{key:"off",value:function(e,t){return this._observable.off(e,t),this}},{key:"_renderContainer",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.select(t).append("g").attr("class",n[this.className]).attr("transform","translate("+i+", "+r+")")}},{key:"render",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(this.destroy(),this._container=this._renderContainer(e,t,i),!this._container)throw"Component "+this._className+" was not rendered. Check your selector: "+e;return this._container.datum(r),this._container.on("click",function(e){n._observable.fire("click",e)}).on("mouseenter",function(e){n._observable.fire("enter",e)}).on("mouseleave",function(e){n._observable.fire("leave",e)}),this}},{key:"destroy",value:function(){return this.isRendered()&&(this._lastData=null,this.clearData(),this._container.datum(null),this._container.remove(),this._container=null),this}},{key:"clearData",value:function(){if(!this.isRendered())throw"Can't call clearData() when widget is not rendered, please call .render() first.";return this._clearData(),this._data=null,this}},{key:"isRendered",value:function(){return null!==this._container}},{key:"setData",value:function(e){if(!this.isRendered())throw"Can't call setData() when component is not rendered, please call .render() first.";return this._setData(this._container,e,this._lastData),this._lastData=Object.assign({},this._lastData,e),this}},{key:"className",get:function(){return this._className}},{key:"container",get:function(){return this._container}},{key:"observable",get:function(){return this._observable}}]),t}(),l=40,h=function(e){function t(){return i(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"diagram-edges"))}return o(t,e),r(t,[{key:"_setData",value:function(e,t){e.selectAll("*").remove(),this._renderDefs(),this._renderEdges(t)}},{key:"_renderDefs",value:function(){this.container.append("svg:defs").append("svg:marker").attr("id","end").attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",5).attr("markerHeight",5).attr("orient","auto").style("fill","#4a4a4a").style("stroke-opacity",.6).append("svg:path").attr("d","M0,-5L10,0L0,5")}},{key:"_renderEdges",value:function(e){var t=this,n=e.layout;e.edges.forEach(function(e,i){var r=t.container.append("path").attr("class","link").attr("stroke","#4a4a4a").attr("stroke-width",1).attr("stroke-linejoin","bevel").attr("fill","transparent").attr("d",function(){var e=n.edges[i].sections[0],r="";if(e.startPoint&&e.endPoint){r+="M"+e.startPoint.x+" "+e.startPoint.y+" ";var o={x:e.startPoint.x,y:e.startPoint.y};(e.bendPoints||[]).forEach(function(n,i){var a=e.bendPoints[i+1]||e.endPoint,s=t._getSectionParams(n,o,a,6),d=t._getSection(s);r+=d,o.x=n.x,o.y=n.y},t);var a={},s=t._getSectionParams(e.endPoint,o,a,6,!0),d=t._getSection(s);r+=d}return r});"arrow"==e.type&&r.attr("marker-end","url(#end)")})}},{key:"_getSection",value:function(e){var t=e.x,n=e.y,i=e.defaultRadius,r=e.isEnd,o="",a="",s=i,d={lastX:t.rounded-t.lastRounded,lastY:n.rounded-n.lastRounded,nextX:t.nextRounded-t.rounded,nextY:n.nextRounded-n.rounded};Object.keys(d).forEach(function(e){var t=Math.abs(d[e]);t&&t<s&&(s=t/2)});var l=r?0:s;return d.lastX>0?a="L "+(t.current-l)+" "+n.current+" ":d.lastX<0?a="L "+(t.current+l)+" "+n.current+" ":d.lastY>0?a="L "+t.current+" "+(n.current-l)+" ":d.lastY<0&&(a="L "+t.current+" "+(n.current+l)+" "),r||(d.nextY>0?o="Q "+t.current+" "+n.current+" "+t.current+" "+(n.current+s)+" ":d.nextY<0?o="Q "+t.current+" "+n.current+" "+t.current+" "+(n.current-s)+" ":d.nextX<0?o="Q "+t.current+" "+n.current+" "+(t.current-s)+" "+n.current+" ":d.nextX>0&&(o="Q "+t.current+" "+n.current+" "+(t.current+s)+" "+n.current+" ")),a.concat(o)}},{key:"_getSectionParams",value:function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return{x:{current:e.x,last:t.x,next:n.x,rounded:Math.round(e.x),lastRounded:Math.round(t.x),nextRounded:Math.round(n.x)},y:{current:e.y,last:t.y,next:n.y,rounded:Math.round(e.y),lastRounded:Math.round(t.y),nextRounded:Math.round(n.y)},defaultRadius:i,isEnd:r}}}]),t}(d),u=function(e){function t(e){var n=e.nodeWidth,r=e.iconFontFamily;i(this,t);var o=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"diagram-node"));return o._nodeWidth=n,o._iconFontFamily=r,o._observable.add("enterNode"),o}return o(t,e),r(t,[{key:"_setData",value:function(e,t){e.selectAll("*").remove(),this._node=t.node,this._selected=t.selected,this._selectedMuted=t.selectedMuted,this._selectedSubsequent=t.selectedSubsequent,this._styles=t.styles,this._groupColor=t.groupColor,this._renderAll()}},{key:"_renderAll",value:function(){this._renderGradients(),this._renderNodeBaseLayer(),this._renderNodeSkeleton(),this._node.icon&&this._renderIcon(),this._renderLine(),this._setNodeStyle(),this._rendertNodeName()}},{key:"_renderGradients",value:function(){this._gradientEdge=40/this._nodeWidth,this._defs=this.container.append("svg:defs"),this._renderDefaultGradient(),this._renderMutedGradient()}},{key:"_renderDefaultGradient",value:function(){this._defaultGradient=this._defs.append("svg:linearGradient").attr("id","node-background-default-"+this._node.name),this._defaultGradient.selectAll("stop").data([{offset:"0",color:this._groupColor,opacity:"0.4"},{offset:this._gradientEdge,color:this._groupColor,opacity:"0.4"},{offset:this._gradientEdge+.001,color:"rgba(255,255,255,1)",opacity:"1"},{offset:"1",color:"rgba(255,255,255,1)",opacity:"1"}]).enter().append("stop").attr("offset",function(e){return e.offset}).attr("stop-color",function(e){return e.color}).attr("stop-opacity",function(e){return e.opacity})}},{key:"_renderMutedGradient",value:function(){this._mutedGradient=this._defs.append("svg:linearGradient").attr("id","node-background-muted"),this._mutedGradient.selectAll("stop").data([{offset:"0",color:"#d5d5d5",opacity:"1"},{offset:this._gradientEdge,color:"#d5d5d5",opacity:"1"},{offset:this._gradientEdge+.001,color:"#f0f0f0",opacity:"1"},{offset:"1",color:"#f0f0f0",opacity:"1"}]).enter().append("stop").attr("offset",function(e){return e.offset}).attr("stop-color",function(e){return e.color}).attr("stop-opacity",function(e){return e.opacity})}},{key:"_renderNodeBaseLayer",value:function(){this._nodeBaseLayer=this.container.append("rect").attr("x",0).attr("y",0).attr("width",this._styles.width).attr("height",this._styles.height).attr("fill","white").attr("rx",5)}},{key:"_renderNodeSkeleton",value:function(){this._nodeSkeleton=this.container.append("rect").attr("x",0).attr("y",0).attr("width",this._styles.width).attr("height",this._styles.height).attr("fill","url(#node-background-default-"+this._node.name+")").attr("rx",5).attr("stroke","#4a4a4a").attr("stroke-width",1).attr("class",n["node-skeleton"]).attr("id",this._node.name)}},{key:"_renderIcon",value:function(){this._icon=this.container.append("text").attr("x",20).attr("y",this._styles.height/2+9-1).attr("class",n["node-icon"]).attr("font-family",this._iconFontFamily).attr("font-size",18).attr("fill","#4a4a4a").text(this._node.icon)}},{key:"_renderLine",value:function(){this._line=this.container.append("line").attr("x1",40).attr("y1",0).attr("x2",40).attr("y2",40).attr("stroke","#4a4a4a").attr("stroke-width",1).attr("opacity",0)}},{key:"_setNodeStyle",value:function(){this._selected?this._setSpecialStyle("#f8e71c",1):this._highlighted?this._setSpecialStyle(this._groupColor,.4):this._highlightedSubsequent||!this._selectedMuted&&!this._highlightedMuted?this._setOriginalStyle():this._setMutedStyle()}},{key:"_rendertNodeName",value:function(){this._clipPath=this._defs.append("clipPath").attr("id","node-name-mask"),this._nodeNameMask=this._clipPath.append("rect").attr("x",55).attr("y",0).attr("width",this._nodeWidth-40-25).attr("height",this._styles.height),this._nodeName=this.container.append("g").attr("clip-path","url(#node-name-mask)").append("text").text(this._node.name).attr("x",55).attr("y",l/2+6.5-2).attr("font-size",13).attr("fill","#4a4a4a").attr("class",n["node-name"])}},{key:"setStyle",value:function(){this._setNodeStyle()}},{key:"isSelected",value:function(){return this._selected}},{key:"isSelectedSubsequent",value:function(){return this._selectedSubsequent}},{key:"setSelected",value:function(e){this._selected=e}},{key:"setSelectedSubsequent",value:function(e){this._selectedSubsequent=e}},{key:"setHighlighted",value:function(e){this._highlighted=e}},{key:"setHighlightedSubsequent",value:function(e){this._highlightedSubsequent=e}},{key:"setSelectedMuted",value:function(e){this._selectedMuted=e}},{key:"setHighlightedMuted",value:function(e){this._highlightedMuted=e}},{key:"_setSpecialStyle",value:function(e,t){this._nodeSkeleton.attr("fill",e),this._nodeSkeleton.attr("fill-opacity",t),this._line.attr("opacity","1")}},{key:"_setMutedStyle",value:function(){this._nodeSkeleton.attr("fill","url(#node-background-muted"),this._nodeSkeleton.attr("fill-opacity","1"),this._line.attr("opacity","0")}},{key:"_setOriginalStyle",value:function(){this._nodeSkeleton.attr("fill","url(#node-background-default-"+this._node.name+")"),this._nodeSkeleton.attr("fill-opacity","1"),this._line.attr("opacity","0")}}]),t}(d),c=function(e){function t(e){var n=e.nodeWidth,r=e.mouseControl,o=e.iconFontFamily;i(this,t);var s=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"diagram-nodes"));return s._nodeWidth=n,s._mouseControl=r,s._iconFontFamily=o,s._observable.add("selectNode").add("deselectNode").add("highlightNode").add("unhighlightNode"),s}return o(t,e),r(t,[{key:"_setData",value:function(e,t){var n=this;e.selectAll("*").remove(),this._dataNodes=t.nodes,this._dataEdges=t.edges,this._layout=t.layout,this._groupColors=t.groupColors,this._selected=t.selected,this._subsequentNodes=this._getSubsequentNodes(t),this._createNodes(t),this._renderNodes(),t.nodes.forEach(function(e,t){return n._setNodeData(e,t)}),this._mouseControl&&(this._doSelecting(),this._doHighlighting())}},{key:"_getSubsequentNodes",value:function(e){var t=this;return e.nodes.reduce(function(n,i){var r=t._findEdgesRecursive(e.edges,[i.name]);return n[i.name]=r.map(function(e){return e.end}),n},{})}},{key:"_findEdgesRecursive",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=t.reduce(function(t,i){if(n.indexOf(i)>=0)return t;var r=e.filter(function(e){return e.start===i});return t.concat(r)},[]),r=i.map(function(e){return e.end});return n=n.concat(t),r.length?i.concat(this._findEdgesRecursive(this._dataEdges,r,n)):i}},{key:"_createNodes",value:function(e){var t=this;this._nodes=e.nodes.map(function(){return new u({nodeWidth:t._nodeWidth,iconFontFamily:t._iconFontFamily})})}},{key:"_renderNodes",value:function(){var e=this;this._nodes.forEach(function(t,n){var i=e._dataNodes[n].name,r=e._getStyles(e._layout.children[n]);t.render(e.container.node(),r.x,r.y,n).on("click",function(t){e._nodes[t].isSelected()?e._observable.fire("deselectNode",i):e._observable.fire("selectNode",i)}).on("enter",function(){e._enterTimeout=setTimeout(function(){e._observable.fire("highlightNode",i)},150)}).on("leave",function(){clearTimeout(e._enterTimeout),e._observable.fire("unhighlightNode")})})}},{key:"selectNode",value:function(e){var t=this,n=this._subsequentNodes[e];this._dataNodes.forEach(function(i,r){var o=t._nodes[r],a=n.indexOf(i.name)>=0,s=e===i.name,d=!(s||a);o.setSelected(s),o.setSelectedSubsequent(a),o.setSelectedMuted(d),o.setStyle()})}},{key:"deselectNode",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this._subsequentNodes[e];this._dataNodes.forEach(function(r,o){var a=t._nodes[o];if(a.setSelected(!1),a.setSelectedMuted(!1),n){var s=e===r.name,d=i.indexOf(r.name)>=0,l=!(s||d);a.setHighlighted(s),a.setHighlightedSubsequent(d),a.setHighlightedMuted(l)}a.setStyle()})}},{key:"highlightNode",value:function(e){var t=this,n=this._subsequentNodes[e];this._dataNodes.forEach(function(i,r){var o=t._nodes[r],a=e===i.name,s=n.indexOf(i.name)>=0,d=!(a||s);o.setHighlighted(a),o.setHighlightedSubsequent(s),o.setHighlightedMuted(d),o.setStyle()})}},{key:"unhighlightNode",value:function(){this._nodes.forEach(function(e){e.setHighlighted(!1),e.setHighlightedSubsequent(!1),e.setHighlightedMuted(!1),e.setStyle()})}},{key:"_setNodeData",value:function(e,t){var n=this._getStyles(this._layout.children[t]),i=this._groupColors[e.group]||"#2196F3",r=this._selected===e.name,o=void 0,a=!1;if(this._selected){var s=this._subsequentNodes[this._selected],d=s&&s.indexOf(e.name)>=0;o=!d,a=d}this._nodes[t].setData({node:e,selected:r,selectedSubsequent:a,selectedMuted:o,styles:n,groupColor:i})}},{key:"_doSelecting",value:function(){var e=this;this.on("selectNode",function(t){e.selectNode(t)}),this.on("deselectNode",function(t){e.deselectNode(t,!0)})}},{key:"_doHighlighting",value:function(){var e=this;this.on("highlightNode",function(t){e.highlightNode(t)}),this.on("unhighlightNode",function(){e.unhighlightNode()})}},{key:"_getStyles",value:function(e){return{y:e.y,x:e.x,width:e.width,height:e.height}}}]),t}(d);return function(s){function d(e){var n=e.nodeWidth,r=void 0===n?190:n,o=e.nodeHeight,s=void 0===o?l:o,h=e.groupColors,u=void 0===h?{}:h,c=e.elkWorkerUrl,_=e.diagramMargin,f=void 0===_?50:_,g=e.mouseControl,y=void 0!==g&&g,v=e.iconFontFamily;i(this,d);var p=a(this,(d.__proto__||Object.getPrototypeOf(d)).call(this,"diagram"));return p._nodeWidth=r,p._nodeHeight=s,p._groupColors=u,p._elkWorkerUrl=c,p._diagramMargin=f,p._mouseControl=y,p._iconFontFamily=v,p._hasRenderedNodes=!1,p._elk=new t({workerUrl:p._elkWorkerUrl}),p._observable.add("selectNode").add("deselectNode").add("highlightNode").add("unhighlightNode"),p}return o(d,s),r(d,[{key:"_renderContainer",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.select(t).append("svg").attr("class",n[this.className]).attr("transform","translate("+i+", "+r+")")}},{key:"_setData",value:function(e,t){e.selectAll("*").remove(),this._dataEdges=t.edges||[],this._dataNodes=t.nodes||[],this._data=t,this._renderElk()}},{key:"_renderElk",value:function(){var e=this,t=this._getElkGraph();return this._elk.layout(t).then(function(t){e._renderNodes(t),e._renderEdges(t),e._setGraphSize(t.children,t.edges),e._hasRenderedNodes=!0})}},{key:"_getElkGraph",value:function(){var e=this;return{id:"root",properties:this._getRootProperties(),children:this._dataNodes.map(function(t){return{id:t.name,width:e._nodeWidth,height:e._nodeHeight}}),edges:this._dataEdges.map(function(e,t){return{id:"edge_"+t,sources:[e.start],targets:[e.end]}})}}},{key:"_getRootProperties",value:function(){return{algorithm:"layered",direction:"RIGHT"}}},{key:"_setGraphSize",value:function(e,t){var n=t.flatMap(function(e){return e.sections.filter(function(e){return e.bendPoints})}),i=n.flatMap(function(e){return e.bendPoints.flatMap(function(e){return e.y})}),r=Math.max.apply(Math,i),o=Math.max.apply(Math,e.map(function(e){return e.y+e.height})),a=Math.max(r,o),s=Math.max.apply(Math,e.map(function(e){return e.x+e.width}));this.container.style("width",s+10+"px"),this.container.style("height",a+10+"px"),this.container.style("margin",this._diagramMargin+"px")}},{key:"_renderEdges",value:function(e){var t={layout:e,edges:this._dataEdges};this._edges=new h,this._edges.render(this.container.node()),this._edges.setData(t)}},{key:"_renderNodes",value:function(e){var t=this,n={nodes:this._data.nodes,edges:this._data.edges,selected:this._data.selected,layout:e,groupColors:this._groupColors};this._nodes=new c({nodeWidth:this._nodeWidth,mouseControl:this._mouseControl,iconFontFamily:this._iconFontFamily}),this._nodes.render(this.container.node()).on("selectNode",function(e){t._observable.fire("selectNode",e)}).on("deselectNode",function(e,n){t._observable.fire("deselectNode",e,n)}).on("highlightNode",function(e){t._observable.fire("highlightNode",e)}).on("unhighlightNode",function(e){t._observable.fire("unhighlightNode",e)}),this._nodes.setData(n)}},{key:"hasRenderedNodes",value:function(){return this._hasRenderedNodes}},{key:"selectNode",value:function(e){this._nodes.selectNode(e)}},{key:"deselectNode",value:function(e){this._nodes.deselectNode(e)}},{key:"highlightNode",value:function(e){this._nodes.highlightNode(e)}},{key:"unhighlightNode",value:function(){this._nodes.unhighlightNode()}},{key:"_clearData",value:function(){this._dataEdges=null,this._dataNodes=null,this._edges=null,this._nodes=null,this._elk=null}}]),d}(d)});
//# sourceMappingURL=clever-diagram-1.1.1.min.js.map
