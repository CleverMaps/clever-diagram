{"version":3,"file":"diagram.min.js","sources":["../src/utils/Observable.js","../src/Diagram.js"],"sourcesContent":["/**\r\n * @class\r\n * Observable class, handles binding and firing events\r\n * @param {Array} events list of events for this observable\r\n */\r\nexport default class Observable {\r\n    /**\r\n     * @param {Array} events\r\n     */\r\n    constructor(events = []) {\r\n        // create a map of handlers where each event has an array of bound handlers\r\n        this._handlers = events.reduce((acc, cur)=>{\r\n            acc[cur] = [];\r\n            return acc;\r\n        },{});\r\n    }\r\n\r\n\t/**\r\n\t * @public\r\n\t * Bind event\r\n\t * @param {String} event event name\r\n\t * @param {Function} handler event handler\r\n\t */\r\n    on(event, handler) {\r\n        if (!(event in this._handlers)) throw \"No such event: \" + event;\r\n\t\tthis._handlers[event].push(handler);\r\n\t\treturn this;\r\n    }\r\n\r\n\t/**\r\n\t * @public\r\n\t * Unbind event\r\n\t * @param {String} event event name\r\n\t * @param {Function} [handler] event handler, optional\r\n\t */\r\n    off(event, handler) {\r\n        if (!(event in this._handlers)) throw \"No such event: \" + event;\r\n\t\tif (!handler) {\r\n\t\t\tthis._handlers[event] = [];\r\n\t\t} else {\r\n\t\t\tvar handlers = this._handlers[event];\r\n\t\t\tvar index = handlers.indexOf(handler);\r\n\t\t\tif (index != -1){\r\n\t\t\t\thandlers.splice(index, 1);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn this;\r\n    }\r\n\r\n\t/**\r\n\t * @public\r\n\t * Fire widget event\r\n\t * @param {String} event event name\r\n\t * @param {*} ...args event arguments\r\n\t */\r\n\tfire(event, ...args) {\r\n\t\tif (!(event in this._handlers)) throw \"No such event: \" + event;\r\n\t\tvar handlers = this._handlers[event];\r\n\t\tfor (var i = 0; i < handlers.length; i++) {\r\n\t\t\thandlers[i].apply(this, args);\r\n\t\t}\r\n\t\treturn this;\r\n    }\r\n\r\n\t/**\r\n\t * @public\r\n\t * Destorys this observable, removes events and so on \r\n\t */\r\n\tdestroy() {\r\n\t\tthis._handlers = null;\r\n\t\treturn this;\r\n    }\r\n\t\r\n}","import Observable from \"./utils/Observable\";\r\nimport style from \"./Diagram.css\";\r\nimport * as d3 from \"d3\";\r\nimport * as jsPlumb from \"jsPlumb\";\r\nimport * as $klay from \"$klay\";\r\n\r\n/**\r\n * @class\r\n * Main Diagram class\r\n * @param {Object} options\r\n */\r\nexport default class Diagram {\r\n\tconstructor(options) {\r\n\t\t/**\r\n\t\t * @private\r\n\t\t * observable handler\r\n\t\t */\r\n\t\tthis._observable = new Observable([\r\n\t\t\t/**\r\n\t\t\t * @event \r\n\t\t\t * Fires when node is selected\r\n\t\t\t * @param {String} node name\r\n\t\t\t */\r\n\t\t\t\"nodeSelected\",\r\n\t\t\t/**\r\n\t\t\t * @event \r\n\t\t\t * Fires when node is selected\r\n\t\t\t * @param {String} node name\r\n\t\t\t */\r\n\t\t\t\"nodeDeselected\",\t\t\t\r\n\t\t\t/**\r\n\t\t\t * @event \r\n\t\t\t * Fires when node is highlighted\r\n\t\t\t * @param {String} node name\r\n\t\t\t * @param {Boolean} highlighted\r\n\t\t\t */\r\n\t\t\t\"nodeHighlight\"\r\n\t\t]);\r\n\r\n\t\tthis._options = options || {};\r\n\r\n\t\t/**\r\n\t\t * @private \r\n\t\t * DOM container for diagram\r\n\t\t */\r\n\t\tthis._container = null;\r\n\r\n\t\tthis._groupColors = options.groupColors || {};\r\n\t}\r\n\r\n\t/**\r\n\t * Bind widget event\r\n\t * @param {String} event event name\r\n\t * @param {Function} handler event handler\r\n\t * @returns {Bar} returns this widget instance\r\n\t */\r\n\ton(eventName, handler) {\r\n\t\tthis._observable.on(eventName, handler);\r\n\t\treturn this;\r\n\t}\r\n\r\n\t/**\r\n\t * Unbind widget event\r\n\t * @param {String} event event name\r\n\t * @param {Function} [handler] event handler\r\n\t * @returns {Bar} returns this widget instance\r\n\t */\r\n\toff(eventName, handler) {\r\n\t\tthis._observable.off(eventName, handler);\r\n\t\treturn this;\r\n\t}\t\r\n\r\n\t/**\r\n\t * Destroys widget\r\n\t * @returns {Bar} returns this widget instance\r\n\t */\r\n\tdestroy() {\r\n\t\tthis._observable.destroy();\r\n\t\tthis._plumb.clear();\r\n\t\tthis._el.remove();\r\n\t\treturn this;\r\n\t}\t\r\n\r\n\t/**\r\n\t * Render logic of this widget\r\n\t * @param {String|DOMElement} selector selector or DOM element \r\n\t * @returns {Bar} returns this widget instance\r\n\t */\r\n\trender(selector) {\r\n\t\tthis._container = d3.select(selector);\r\n\t\tthis._el = this._container.append(\"div\").classed(style.diagram, true);\r\n\t\tthis._plumb = jsPlumb.getInstance();\r\n\t}\r\n\r\n\t_getKlayGraph(){\r\n\t\treturn {\r\n\t\t\t\"id\": \"root\",\r\n\t\t\t\"children\": this._nodes.map(node=>{\r\n\t\t\t\treturn {\r\n\t\t\t\t\tid:node.name,\r\n\t\t\t\t\twidth:150,\r\n\t\t\t\t\theight:50\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\t\"edges\": this._edges.map((edge, index)=>{\r\n\t\t\t\treturn {\r\n\t\t\t\t\tid:\"edge_\"+index,\r\n\t\t\t\t\tsource:edge.start,\r\n\t\t\t\t\ttarget:edge.end\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}\r\n\t}\r\n\r\n\t_setGraphSize(nodes){\r\n\t\tvar maxHeight = Math.max.apply(Math, nodes.map(node=>node.y+node.height));\r\n\t\tvar maxWidth = Math.max.apply(Math, nodes.map(node=>node.x+node.width));\r\n\r\n\t\tthis._el.style(\"width\", maxWidth+\"px\");\r\n\t\tthis._el.style(\"height\", maxHeight+\"px\");\r\n\t}\r\n\r\n\t/**\r\n\t * Renders nodes\r\n\t */\r\n\t_renderNodes(){\r\n\t\treturn new Promise((success, failure)=>{\r\n\t\t\t$klay.layout({\r\n\t\t\t\tgraph: this._getKlayGraph(),\r\n\t\t\t\toptions:{\r\n\t\t\t\t\tspacing:40,\r\n\t\t\t\t\talgorithm: \"de.cau.cs.kieler.klay.layered\",\r\n\t\t\t\t\tlayoutHierarchy: true,\r\n\t\t\t\t\tintCoordinates: true,\r\n\t\t\t\t\tdirection: \"RIGHT\",\r\n\t\t\t\t\t//thoroughness:50,\r\n\t\t\t\t\t//crossMin:\"LAYER_SWEEP\",\r\n\t\t\t\t\tmergeEdges:true,\r\n\t\t\t\t\t//linearSegmentsDeflectionDampening:0.5,\r\n\t\t\t\t\tlayerConstraint:\"LAST_SEPARATE\",\r\n\t\t\t\t\tnodePlace:\"BRANDES_KOEPF\", // LINEAR_SEGMENTS BRANDES_KOEPF\r\n\t\t\t\t\tnodeLayering: \"NETWORK_SIMPLEX\" // NETWORK_SIMPLEX LONGEST_PATH INTERACTIVE\r\n\t\t\t\t},\r\n\t\t\t\tsuccess: (layouted)=>{\r\n\t\t\t\t\tthis._nodes.forEach((node, i)=>{\r\n\t\t\t\t\t\tvar styles = {\r\n\t\t\t\t\t\t\ttop:layouted.children[i].y,\r\n\t\t\t\t\t\t\tleft:layouted.children[i].x,\r\n\t\t\t\t\t\t\twidth:layouted.children[i].width,\r\n\t\t\t\t\t\t\theight:layouted.children[i].height\r\n\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\tthis._renderNode(node, styles);\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tthis._renderEdges();\r\n\t\t\t\t\tthis._plumb.draggable(document.querySelectorAll(\".\"+style.node));\r\n\t\t\t\t\tthis._setGraphSize(layouted.children);\t\r\n\t\t\t\t\tsuccess();\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t},\r\n\t\t\t\terror: function(error) { \r\n\t\t\t\t\tconsole.log(error); \r\n\t\t\t\t\tfailure();\r\n\t\t\t\t}\r\n\t\t\t});\t\t\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * @public\r\n\t * Selects node \r\n\t * @param nodeName\r\n\t */\r\n\tselectNode(nodeName){\r\n\t\tvar el = document.getElementById(nodeName);\r\n\t\tif (!el) throw \"Node \"+nodeName + \" doesn't exist or graph hasn't been rendered yet\";\r\n\r\n\t\tvar nodeEl = d3.select(el);\r\n\r\n\t\tvar selectedClass = style[\"node-selected\"];\r\n\r\n\t\tif (!nodeEl.classed(selectedClass)){\r\n\t\t\td3.select(\".\"+selectedClass).classed(selectedClass, false);\r\n\t\t\tnodeEl.classed(selectedClass, true);\r\n\t\t\tthis._observable.fire(\"nodeSelected\", nodeName);\r\n\r\n\t\t\tif (this._selectedNodeName && nodeName != this._selectedNodeName){\r\n\t\t\t\tthis._observable.fire(\"nodeDeselected\", this._selectedNodeName);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthis._selectedNodeName = nodeName;\r\n\t\t} else {\r\n\t\t\td3.select(\".\"+selectedClass).classed(selectedClass, false);\r\n\t\t\tthis._observable.fire(\"nodeDeselected\", nodeName);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * @public\r\n\t * Highlights node \r\n\t * @param nodeName\r\n\t * @param highlighted\r\n\t */\r\n\thighlightNode(nodeName, highlighted){\r\n\t\tvar nodeEl = d3.select(\"#\"+nodeName);\r\n\t\tvar highlightedClass = style[\"node-highlighted\"];\r\n\r\n\t\tif (this._dragging && d3.event.relatedTarget && d3.event.relatedTarget.tagName == \"path\"){\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (highlighted){\r\n\t\t\td3.select(\".\"+highlightedClass).classed(highlightedClass, false);\r\n\t\t\tnodeEl.classed(highlightedClass, true);\r\n\t\t\tthis._observable.fire(\"nodeHighlight\", nodeName, highlighted);\r\n\t\t} else {\r\n\t\t\td3.select(\".\"+highlightedClass).classed(highlightedClass, false);\r\n\t\t\tthis._observable.fire(\"nodeHighlight\", nodeName, highlighted);\r\n\t\t}\r\n\t}\r\n\t\r\n\t_onMouseDown(nodeName){\r\n\t\tthis._dragging = true;\r\n\t\t// save box on mouse down so we can compare on mouseup\r\n\t\tthis._mouseDownBB = document.getElementById(nodeName).getBoundingClientRect();\r\n\t}\r\n\r\n\t_onMouseUp(nodeName){\r\n\t\tvar bb = document.getElementById(nodeName).getBoundingClientRect();\r\n\t\t// only call select when bounding box is same\r\n\t\tif (this._mouseDownBB && this._mouseDownBB.top == bb.top && this._mouseDownBB.left == bb.left){\r\n\t\t\tthis.selectNode(nodeName);\r\n\t\t}\r\n\t\tthis._dragging = false;\t\t\r\n\t}\r\n\t/**\r\n\t * Renders node \r\n\t * @param node\r\n\t */\r\n\t_renderNode(node, styles){\r\n\t\tvar color = this._groupColors[node.group] || \"#2196F3\";\r\n\t\tvar styleStr = Object.keys(styles).map(style=>style+\":\"+styles[style]+\"px\").join(\";\")+\"; background-color:\"+color;\r\n\t\tvar nodeEl = this._el\r\n\t\t\t.append(\"div\")\r\n\t\t\t.attr(\"style\", styleStr)\r\n\t\t\t.attr(\"class\", style.node)\r\n\t\t\t.attr(\"id\", node.name)\r\n\t\t\t.on(\"mousedown\", ()=>{\r\n\t\t\t\tthis._onMouseDown(node.name);\r\n\t\t\t})\r\n\t\t\t.on(\"mouseup\", ()=>{\r\n\t\t\t\tthis._onMouseUp(node.name);\r\n\t\t\t})\r\n\t\t\t.on(\"mouseover\", ()=>{\r\n\t\t\t\tthis.highlightNode(node.name, true);\r\n\t\t\t}).on(\"mouseout\", ()=>{\r\n\t\t\t\tthis.highlightNode(node.name, false);\r\n\t\t\t});\r\n\r\n\t\tnodeEl\t\r\n\t\t\t.append(\"div\")\r\n\t\t\t.attr(\"class\", style[\"node-text\"])\r\n\t\t\t.html(node.name)\r\n\t}\r\n\r\n\t_getEdgeOverlay(edge){\r\n\t\treturn {\r\n\t\t\t\"arrow\":[ [ \"PlainArrow\", { location:1, width:10, length:10 } ] ],\r\n\t\t\t\"link\":[],\r\n\t\t}[edge.type]\r\n\t}\r\n\r\n\t/**\r\n\t * Renders edges\r\n\t */\r\n\t_renderEdges(){\r\n\t\tthis._edges.forEach(edge=>{\r\n\t\t\tvar overlay = this._getEdgeOverlay(edge);\r\n\t\t\tthis._plumb.connect({\r\n\t\t\t\tsource:edge.start,\r\n\t\t\t\ttarget:edge.end,\r\n\t\t\t\tanchor:[ \"TopCenter\",\"RightMiddle\",\"BottomCenter\",\"LeftMiddle\" ],\r\n\t\t\t\tendpoint:\"Blank\",\r\n\t\t\t\tpaintStyle:{ stroke:'#546E7A', strokeWidth:2 },\r\n\t\t\t\tconnector :\"Straight\", //\"Flowchart\" \"Straight\",\r\n\t\t\t\toverlays: overlay,\r\n\t\t\t\tendpointStyle:{ fill: \"black\" }\t\t\t\t\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Sets widget data\r\n\t * @param {Array} data\r\n\t * @returns {Bar} returns this widget instance \r\n\t */\r\n\tsetData(data) {\r\n\t\tif (!this._container) throw \"Diagram is not rendered\"\r\n\r\n\t\tthis._el.html(\"\");\r\n\r\n\t\tthis._nodes = data.nodes || [];\r\n\t\tthis._edges = data.edges || [];\r\n\r\n\t\treturn this._renderNodes();\r\n\t}\r\n}\r\n"],"names":["Observable","events","_handlers","reduce","acc","cur","event","handler","this","push","handlers","index","indexOf","splice","args","i","length","apply","options","_observable","_options","_container","_groupColors","groupColors","eventName","on","off","destroy","_plumb","clear","_el","remove","selector","d3","append","classed","style","diagram","jsPlumb","_nodes","map","node","name","_edges","edge","start","end","nodes","maxHeight","Math","max","y","height","maxWidth","x","width","Promise","success","failure","_this","_getKlayGraph","layouted","forEach","styles","children","_renderNode","_renderEdges","draggable","document","querySelectorAll","_setGraphSize","error","log","nodeName","el","getElementById","nodeEl","selectedClass","fire","_selectedNodeName","highlighted","highlightedClass","_dragging","relatedTarget","tagName","_mouseDownBB","getBoundingClientRect","bb","top","left","selectNode","color","group","styleStr","Object","keys","join","attr","_onMouseDown","_onMouseUp","highlightNode","html","location","type","overlay","_this3","_getEdgeOverlay","connect","stroke","strokeWidth","fill","data","edges","_renderNodes"],"mappings":"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"}